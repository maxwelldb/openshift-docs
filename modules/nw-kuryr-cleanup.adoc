// Module included in the following assemblies:
//
// * networking/ovn_kubernetes_network_provider/migrate-from-kuryr-sdn.adoc

:_content-type: PROCEDURE
[id="nw-kuryr-cleanup_{context}"]
= Cleaning up resources after migration

After migration is done, there are necessary steps to clean up resources created by Kuryr. From high level perspective it will include:

* Removing Kuryr finalizers from resources
* Removing Kuryr CRDs
* Removing {rh-openstack-first} resources

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Install `jq` tool
* Install Python interpreter
* Install `openstacksdk` python package
* Install `openstack` cli tool
* Access to the underlying {rh-openstack}
* Access to the cluster as a user with the `cluster-admin` role.

.Procedure

. Find out cluster and Kuryr related identifiers, which will be used later:
+
[source,terminal]
----
$ CLUSTERID=$(oc get infrastructure.config.openshift.io cluster -o=jsonpath='{.status.infrastructureName}')
$ CLUSTERTAG="openshiftClusterID=${CLUSTERID}"
$ ROUTERID=$(oc get kuryrnetwork -A --no-headers -o custom-columns=":status.routerId"|head -n 1)
----

. Create helper bash function, which will help out with removing finalizers
from specified resources. It might look complicated, but it simply gets two
parameters - first one is name of the resource, and the second is the
finalizer to be removed. Than it will get all the desired resource from the
cluster and replace it's definition with the same data excluding specified
finalizer. Note, that executing this function for certain resources may
require to execute it again with the same parameters in case of conflict
errors.
+
[source,terminal]
----
$ function REMFIN {
    local resource=$1
    local finalizer=$2
    for res in $(oc get $resource -A --template='{{range $i,$p := .items}}{{ $p.metadata.name }}|{{ $p.metadata.namespace }}{{"\n"}}{{end}}'); do
        name=${res%%|*}
        ns=${res##*|}
        oc get -n $ns $resource $name -o json |
            jq -Mcr "if .metadata.finalizers != null then del(.metadata.finalizers[] | select(. == \"${finalizer}\")) else . end" |
            oc replace -n $ns $resource $name -f -
    done
}
----

. Remove Kuryr finalizers from services:
+
[source,terminal]
----
$ REMFIN services kuryr.openstack.org/service-finalizer
----

. Remove all tagged {rh-openstack} Load Balancers from Octavia:
+
[source,terminal]
----
$ for lb in $(openstack loadbalancer list --tags $CLUSTERTAG -f value -c id); do
    openstack loadbalancer delete --cascade $lb
done
----

. Remove Kuryr finalizers from all KuryrLoadBalancer CRs. This will trigger their deletion:
+
[source,terminal]
----
$ REMFIN kuryrloadbalancers.openstack.org kuryr.openstack.org/kuryrloadbalancer-finalizers
----

. Remove Kuryr service network:
+
[source,terminal]
----
$ openstack router remove subnet $ROUTERID ${CLUSTERID}-kuryr-service-subnet
$ openstack network delete ${CLUSTERID}-kuryr-service-network
----

. Remove Kuryr finalizers from all pods:
+
[source,terminal]
----
$ REMFIN pods kuryr.openstack.org/pod-finalizer
----

. Remove Kuryr finalizers from all KuryrPort CRs, as a consequence, KuryrPort CRs will be deleted:
+
[source,terminal]
----
$ REMFIN kuryrports.openstack.org kuryr.openstack.org/kuryrport-finalizer
----

. Remove Kuryr finalizers from all Network Policies:
+
[source,terminal]
----
$ REMFIN networkpolicy kuryr.openstack.org/networkpolicy-finalizer
$ REMFIN kuryrnetworkpolicies.openstack.org kuryr.openstack.org/networkpolicy-finalizer
----

. Remove subports created by Kuryr from trunks. Note, it will take a time, since for every subport there is a check if such port is tagged with `$CLUSTERTAG`:
+
[source,terminal]
----
$ read -ra trunks <<< $(python -c "import openstack; n = openstack.connect().network; print(' '.join([x.id for x in n.trunks(any_tags='$CLUSTERTAG')]))")
$ i=0
$ for trunk in "${trunks[@]}"; do
    i=$((i+1))
    echo "Processing trunk $trunk, ${i}/${#trunks[@]}."
    subports=()
    for subport in $(python -c "import openstack; n = openstack.connect().network; print(' '.join([x['port_id'] for x in n.get_trunk('$trunk').sub_ports if '$CLUSTERTAG' in n.get_port(x['port_id']).tags]))"); do 
        subports+=("$subport");
    done
    args=()
    for sub in "${subports[@]}" ; do
        args+=("--subport $sub")
    done
    if [ ${#args[@]} -gt 0 ]; then
        openstack network trunk unset ${args[*]} $trunk
    fi
done
----

. Get all networks and subnets from KuryrNetwork CRs and remove ports, router interfaces and network itself:
+
[source,terminal]
----
$ mapfile -t kuryrnetworks < <(oc get kuryrnetwork -A --template='{{range $i,$p := .items}}{{ $p.status.netId }}|{{ $p.status.subnetId }}{{"\n"}}{{end}}')
$ i=0
$ for kn in "${kuryrnetworks[@]}"; do
    i=$((i+1))
    netID=${kn%%|*}
    subnetID=${kn##*|}
    echo "Processing network $netID, ${i}/${#kuryrnetworks[@]}"
    # Remove all ports from the network.
    for port in $(python -c "import openstack; n = openstack.connect().network; print(' '.join([x.id for x in n.ports(network_id='$netID') if x.device_owner != 'network:router_interface']))"); do
        ( openstack port delete $port ) &

        # Only allow 20 jobs in parallel.
        if [[ $(jobs -r -p | wc -l) -ge 20 ]]; then
            wait -n
        fi
    done
    wait

    # Remove the subnet from the router.
    openstack router remove subnet $ROUTERID $subnetID

    # Remove the network.
    openstack network delete $netID
done
----

. Remove Kuryr security group
+
[source,terminal]
----
openstack security group delete ${CLUSTERID}-kuryr-pods-security-group
----

. Remove all tagged subnetpools and remove them:
+
[source,terminal]
----
$ for subnetpool in $(openstack subnet pool list --tags $CLUSTERTAG -f value -c ID); do
    openstack subnet pool delete $subnetpool
done
----

. Check for all the networks based on KuryrNetwork CRs are removed. This command will give you list of still existing networks, otherwise it should return no output.
+
[source,terminal]
----
networks=$(oc get kuryrnetwork -A --no-headers -o custom-columns=":status.netId")
for existingNet in $(openstack network list --tags $CLUSTERTAG -f value -c ID); do
    if [[ $networks =~ $existingNet ]]; then
        echo "Network still exists: $existingNet"
    fi
done
----
+
If there are any existing networks listed, they should be investigated and removed one by one before continuing.

. Removing network policy related security groups:
+
[source,terminal]
----
$ for sgid in $(openstack security group list -f value -c ID -c Description | grep 'Kuryr-Kubernetes Network Policy' | cut -f 1 -d ' '); do
    openstack security group delete $sgid
done
----

. Remove finalizers from KuryrNetwork CRs:
+
[source,terminal]
----
$ REMFIN kuryrnetworks.openstack.org kuryrnetwork.finalizers.kuryr.openstack.org
----

. Finally, if router was created by Cluster Network Operator, router might be removed:
+
[source,terminal]
----
$ openstack router delete $ROUTERID
----
